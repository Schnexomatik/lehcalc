<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>LEH Sizing Calculator</title>
<script src="https://cdn.tailwindcss.com" defer></script>
<style>
  body{box-sizing:border-box;font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#e7e7df}
  .glass{background:rgba(255,255,255,.95);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.2)}
  .card{box-shadow:0 20px 25px -5px rgba(0,0,0,.1),0 10px 10px -5px rgba(0,0,0,.04)}
  :root{--sys:#ff5000;--sys-dark:#e04500;--env:#02a880;--env-dark:#028a6b;--track:#d1d5db}
  .slider{-webkit-appearance:none;appearance:none;height:8px;border-radius:4px;background:var(--track);outline:0}
  .system-slider::-webkit-slider-thumb{-webkit-appearance:none;width:22px;height:22px;border-radius:50%;border:0;background:linear-gradient(135deg,var(--sys),var(--sys-dark));box-shadow:0 4px 12px rgba(255,80,0,.35)}
  .system-slider::-moz-range-thumb{width:22px;height:22px;border-radius:50%;border:0;background:linear-gradient(135deg,var(--sys),var(--sys-dark));box-shadow:0 4px 12px rgba(255,80,0,.35)}
  .env-slider::-webkit-slider-thumb{-webkit-appearance:none;width:22px;height:22px;border-radius:50%;border:0;background:linear-gradient(135deg,var(--env),var(--env-dark));box-shadow:0 4px 12px rgba(2,168,128,.35)}
  .env-slider::-moz-range-thumb{width:22px;height:22px;border-radius:50%;border:0;background:linear-gradient(135deg,var(--env),var(--env-dark));box-shadow:0 4px 12px rgba(2,168,128,.35)}
  .input-field{transition:all .2s ease;border-radius:8px}
  .system-input{border-color:var(--sys)!important}.system-input:focus{box-shadow:0 4px 12px rgba(255,80,0,.25)!important;border-color:var(--sys)!important}
  .env-input{border-color:var(--env)!important}.env-input:focus{box-shadow:0 4px 12px rgba(2,168,128,.25)!important;border-color:var(--env)!important}
  .radio-option{transition:all .2s ease;border-radius:8px}
  .radio-option:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.08)}
  .env-radio.selected{background:linear-gradient(135deg,var(--env),var(--env-dark))!important;border-color:var(--env)!important;color:#fff!important}
  .gauge{background:#e7e7df;border:1px solid rgba(0,0,0,.06)}
  /* PV preview */
  #pvPreview{position:relative;display:inline-block;min-width:140px;min-height:140px}
  .pv-square{position:absolute;border:3px solid var(--env);border-radius:8px;background:linear-gradient(135deg,rgba(2,168,128,.08),rgba(2,138,107,.08))}
  #pvFrame{position:absolute;border:2px dashed #34d399;border-radius:6px;pointer-events:none}
  #pvLabelTop{position:absolute;font-size:12px;color:#065f46;background:rgba(255,255,255,.9);padding:2px 4px;border-radius:6px;border:1px solid #a7f3d0}
  #pvLabelLeft{position:absolute;font-size:12px;color:#065f46;background:rgba(255,255,255,.9);padding:2px 4px;border-radius:6px;border:1px solid #a7f3d0;writing-mode:vertical-rl;text-orientation:mixed}
  .frameLabel{position:absolute;font-size:12px;color:#065f46;background:rgba(255,255,255,.9);padding:2px 6px;border-radius:6px;border:1px solid #a7f3d0}
  #pvFrameLabelRight{writing-mode:vertical-rl;text-orientation:mixed}
  /* Sidebar */
  .sidebar{background:linear-gradient(180deg,#0f172a,#0b2457 60%,#0f172a);color:#fff}
  .vertical-title{writing-mode:vertical-rl;text-orientation:mixed;transform:rotate(180deg)}
  .sidebtn{display:flex;align-items:center;justify-content:center;height:44px;border-radius:10px;font-weight:600}
  .sidebtn-primary{background:linear-gradient(135deg,#06b6d4,#10b981)}
  .sidebtn-secondary{background:linear-gradient(135deg,#64748b,#475569)}
  .sidebtn-ghost{border:1px solid rgba(255,255,255,.3);background:transparent}
  /* Modals */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:50;display:none}
  .modal.show{display:flex}
</style>
</head>
<body class="min-h-screen">
  <!-- 2-column layout: left sidebar + main -->
  <div class="grid" style="grid-template-columns: 160px 1fr; min-height: 100vh;">
    <!-- Sidebar -->
    <aside class="sidebar p-3 md:p-4 flex flex-col gap-4 items-stretch">
      <div class="flex-1 flex items-center justify-center">
        <div class="vertical-title text-center text-lg md:text-xl font-bold leading-none">
          LEH-enabled Asset Tracker
        </div>
      </div>
      <div class="flex flex-col gap-2">
        <button id="resetBtn" class="sidebtn sidebtn-secondary">Reset</button>
        <button id="constantsBtn" class="sidebtn sidebtn-ghost">Constants</button>
        <button id="calculatedBtn" class="sidebtn sidebtn-primary">Calculated</button>
      </div>
    </aside>

    <!-- Main content -->
    <main class="p-3 md:p-5">
      <div class="max-w-7xl mx-auto glass rounded-2xl card p-4 md:p-6">
        <!-- Controls -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6 mb-4 md:mb-6">
          <!-- System -->
          <div class="p-4 md:p-5 rounded-2xl card border border-orange-200" style="background:#e7e7df">
            <div class="flex items-center mb-3">
              <div class="w-3 h-8 rounded-full mr-3" style="background:linear-gradient(to bottom,var(--sys),var(--sys-dark))"></div>
              <h3 class="text-lg md:text-xl font-bold text-gray-800">System Parameters</h3>
            </div>
            <div class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="systemVoltage">System Voltage (V)</label>
                <div class="flex items-center gap-3">
                  <input type="range" id="systemVoltage" class="slider system-slider flex-1" min="1.4" max="3.3" step="0.1" value="3.0">
                  <input type="number" id="systemVoltageNum" class="system-input input-field w-24 px-3 py-2 border-2 rounded-lg text-sm text-center bg-white focus:outline-none" min="1.4" max="3.3" step="0.1" value="3.0">
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="intervalBetweenPulses">Interval Between Pulses (s)</label>
                <div class="flex items-center gap-3">
                  <input type="range" id="intervalBetweenPulses" class="slider system-slider flex-1" min="1" max="3600" step="10" value="600">
                  <input type="number" id="intervalBetweenPulsesNum" class="system-input input-field w-24 px-3 py-2 border-2 rounded-lg text-sm text-center bg-white focus:outline-none" min="1" max="3600" step="10" value="600">
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="sleepCurrent">Sleep Current (nA)</label>
                <div class="flex items-center gap-3">
                  <input type="range" id="sleepCurrent" class="slider system-slider flex-1" min="0" max="1000" step="10" value="650">
                  <input type="number" id="sleepCurrentNum" class="system-input input-field w-24 px-3 py-2 border-2 rounded-lg text-sm text-center bg-white focus:outline-none" min="0" max="1000" step="10" value="650">
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="pulseDuration">Pulse Duration (ms)</label>
                <div class="flex items-center gap-3">
                  <input type="range" id="pulseDuration" class="slider system-slider flex-1" min="0.5" max="50" step="0.5" value="5">
                  <input type="number" id="pulseDurationNum" class="system-input input-field w-24 px-3 py-2 border-2 rounded-lg text-sm text-center bg-white focus:outline-none" min="0.5" max="50" step="0.5" value="5">
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="pulseCurrent">Pulse Current (mA)</label>
                <div class="flex items-center gap-3">
                  <input type="range" id="pulseCurrent" class="slider system-slider flex-1" min="0.1" max="30" step="0.1" value="11">
                  <input type="number" id="pulseCurrentNum" class="system-input input-field w-24 px-3 py-2 border-2 rounded-lg text-sm text-center bg-white focus:outline-none" min="0.1" max="30" step="0.1" value="11">
                </div>
              </div>
            </div>
          </div>

          <!-- Environmental -->
          <div class="p-4 md:p-5 rounded-2xl card border border-emerald-200" style="background:#e7e7df">
            <div class="flex items-center mb-3">
              <div class="w-3 h-8 rounded-full mr-3" style="background:linear-gradient(to bottom,var(--env),var(--env-dark))"></div>
              <h3 class="text-lg md:text-xl font-bold text-gray-800">Environmental Parameters</h3>
            </div>
            <div class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="lightIntensity">Light Intensity (lux)</label>
                <div class="flex items-center gap-3">
                  <input type="range" id="lightIntensity" class="slider env-slider flex-1" min="1" max="2000" step="1" value="200">
                  <input type="number" id="lightIntensityNum" class="env-input input-field w-24 px-3 py-2 border-2 rounded-lg text-sm text-center bg-white focus:outline-none" min="1" max="2000" step="1" value="200">
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="lightDuration">Light Duration per Day (min)</label>
                <div class="flex items-center gap-3">
                  <input type="range" id="lightDuration" class="slider env-slider flex-1" min="1" max="1440" step="1" value="60">
                  <input type="number" id="lightDurationNum" class="env-input input-field w-24 px-3 py-2 border-2 rounded-lg text-sm text-center bg-white focus:outline-none" min="1" max="1440" step="1" value="60">
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="deviceLifetime">Device Lifetime (months)</label>
                <div class="flex items-center gap-3">
                  <input type="range" id="deviceLifetime" class="slider env-slider flex-1" min="1" max="120" step="1" value="36">
                  <input type="number" id="deviceLifetimeNum" class="env-input input-field w-24 px-3 py-2 border-2 rounded-lg text-sm text-center bg-white focus:outline-none" min="1" max="120" step="1" value="36">
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Energy Storage Type</label>
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                  <label class="env-radio radio-option flex items-center px-2 py-1 bg-white border-2 border-gray-300 rounded cursor-pointer">
                    <input type="radio" name="storageType" value="CR" class="mr-1"> <span class="text-xs">CR (1.5%/yr)</span>
                  </label>
                  <label class="env-radio radio-option selected flex items-center px-2 py-1 rounded cursor-pointer text-white" style="background:linear-gradient(135deg,var(--env),var(--env-dark));border-color:var(--env)">
                    <input type="radio" name="storageType" value="LiPo" checked class="mr-1"> <span class="text-xs">LiPo (2.5%/mo)</span>
                  </label>
                  <label class="env-radio radio-option flex items-center px-2 py-1 bg-white border-2 border-gray-300 rounded cursor-pointer">
                    <input type="radio" name="storageType" value="LiFePO" class="mr-1"> <span class="text-xs">LiFePO (1.5%/mo)</span>
                  </label>
                  <label class="env-radio radio-option flex items-center px-2 py-1 bg-white border-2 border-gray-300 rounded cursor-pointer">
                    <input type="radio" name="storageType" value="LTO" class="mr-1"> <span class="text-xs">LTO (3%/mo)</span>
                  </label>
                  <label class="env-radio radio-option flex items-center px-2 py-1 bg-white border-2 border-gray-300 rounded cursor-pointer">
                    <input type="radio" name="storageType" value="NiMH" class="mr-1"> <span class="text-xs">NiMH (1.5%/mo)</span>
                  </label>
                  <label class="env-radio radio-option flex items-center px-2 py-1 bg-white border-2 border-gray-300 rounded cursor-pointer">
                    <input type="radio" name="storageType" value="Supercap" class="mr-1"> <span class="text-xs">Supercap (20%/mo)</span>
                  </label>
                  <label class="env-radio radio-option flex items-center px-2 py-1 bg-white border-2 border-gray-300 rounded cursor-pointer">
                    <input type="radio" name="storageType" value="Hybridcap" class="mr-1"> <span class="text-xs">Hybridcap (20%/mo)</span>
                  </label>
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">PM Solution</label>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                  <label class="env-radio radio-option selected flex items-center px-2 py-1 rounded cursor-pointer text-white" style="background:linear-gradient(135deg,var(--env),var(--env-dark));border-color:var(--env)">
                    <input type="radio" name="pmSolution" value="PMIC" checked class="mr-1"> <span class="text-xs">Full PMIC (90%)</span>
                  </label>
                  <label class="env-radio radio-option flex items-center px-2 py-1 bg-white border-2 border-gray-300 rounded cursor-pointer">
                    <input type="radio" name="pmSolution" value="Discrete" class="mr-1"> <span class="text-xs">Discrete (75%)</span>
                  </label>
                  <label class="env-radio radio-option flex items-center px-2 py-1 bg-white border-2 border-gray-300 rounded cursor-pointer">
                    <input type="radio" name="pmSolution" value="Direct" class="mr-1"> <span class="text-xs">Direct-to-MCU (50%)</span>
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Results grid: 3 columns: [Daily] [Storage] [PV]; LEH spans columns 1-2 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
          <!-- Daily (short) -->
          <div class="gauge p-4 rounded-2xl card">
            <div class="flex items-center justify-center mb-2">
              <div class="w-2 h-6 rounded-full mr-3" style="background:linear-gradient(to bottom,#9470d8,#7c5cc7)"></div>
              <h4 class="text-lg font-bold text-gray-800 text-center">Daily Energy Consumption</h4>
            </div>
            <div class="flex justify-center mb-2">
              <div class="relative w-28 h-28">
                <svg class="-rotate-90 w-28 h-28" viewBox="0 0 160 160" aria-hidden="true">
                  <circle cx="80" cy="80" r="70" stroke="#9ca3af" stroke-width="18" fill="none"/>
                  <circle id="dailyEnergyGauge" cx="80" cy="80" r="70" stroke="url(#dailyGradient)" stroke-width="18" fill="none" stroke-linecap="round" stroke-dasharray="439.8229715" stroke-dashoffset="439.8229715"/>
                  <circle id="dailyOverflow" cx="80" cy="80" r="58" stroke="#7c5cc7" stroke-width="10" fill="none" stroke-linecap="round" stroke-dasharray="364.424747" stroke-dashoffset="364.424747" class="opacity-0"/>
                  <defs>
                    <linearGradient id="dailyGradient" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#9470d8"/><stop offset="100%" stop-color="#7c5cc7"/></linearGradient>
                  </defs>
                </svg>
                <div class="absolute inset-0 flex flex-col items-center justify-center">
                  <div id="dailyEnergy" class="text-lg font-bold" style="color:#9470d8">0.000</div>
                  <div class="text-[11px] text-gray-600">mWh</div>
                </div>
              </div>
            </div>
            <div class="text-[12px] text-gray-600 text-center space-y-1">
              <div>Pulses: <span id="pulseEnergy" class="font-medium" style="color:#9470d8">0.000</span> mWh/day</div>
              <div>Sleep: <span id="sleepEnergy" class="font-medium" style="color:#7c5cc7">0.000</span> mWh/day</div>
            </div>
          </div>

          <!-- Storage (short) -->
          <div class="gauge p-4 rounded-2xl card">
            <div class="flex items-center justify-center mb-2">
              <div class="w-2 h-6 rounded-full mr-3" style="background:linear-gradient(to bottom,#f9af19,#e09a0f)"></div>
              <h4 class="text-lg font-bold text-gray-800 text-center">Energy Storage Requirements</h4>
            </div>
            <div class="flex justify-center mb-2">
              <div class="relative w-28 h-28">
                <svg class="-rotate-90 w-28 h-28" viewBox="0 0 160 160" aria-hidden="true">
                  <circle cx="80" cy="80" r="70" stroke="#9ca3af" stroke-width="18" fill="none"/>
                  <circle id="storageGauge" cx="80" cy="80" r="70" stroke="url(#storageGradient)" stroke-width="18" fill="none" stroke-linecap="round" stroke-dasharray="439.8229715" stroke-dashoffset="439.8229715"/>
                  <circle id="storageOverflow" cx="80" cy="80" r="58" stroke="#e09a0f" stroke-width="10" fill="none" stroke-linecap="round" stroke-dasharray="364.424747" stroke-dashoffset="364.424747" class="opacity-0"/>
                  <defs>
                    <linearGradient id="storageGradient" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#f9af19"/><stop offset="100%" stop-color="#e09a0f"/></linearGradient>
                  </defs>
                </svg>
                <div class="absolute inset-0 flex flex-col items-center justify-center">
                  <div id="totalStorage" class="text-lg font-bold" style="color:#f9af19">0.000</div>
                  <div class="text-[11px] text-gray-600">mWh</div>
                </div>
              </div>
            </div>
            <div class="text-[12px] text-gray-600 text-center space-y-1">
              <div>Dark Period: <span id="darkPeriodEnergy" class="font-medium" style="color:#f9af19">0.000</span> mWh</div>
              <div>Min Storage: <span id="minStorage" class="font-medium" style="color:#e09a0f">0.000</span> mWh</div>
              <div>Self-discharge: <span id="selfDischarge" class="font-medium" style="color:#d18b0a">0.0</span>%/mo</div>
            </div>
          </div>

          <!-- PV Area (spans 2 rows) -->
          <div class="gauge p-4 rounded-2xl card md:row-span-2">
            <div class="flex items-center mb-2">
              <div class="w-2 h-6 rounded-full mr-3" style="background:linear-gradient(to bottom,var(--env),var(--env-dark))"></div>
              <h4 class="text-lg md:text-xl font-bold text-gray-800">Required PV Area (EOL)</h4>
            </div>
            <div class="text-center">
              <div id="pvArea" class="text-2xl md:text-3xl font-bold" style="color:var(--env)">0.00</div>
              <div class="text-gray-600 text-sm mb-2">cm²</div>
              <div class="text-[13px] text-gray-600 mb-3">
                Square side (active): <span id="pvSideActive" class="font-medium">0.00</span> cm<br/>
                Square side (footprint): <span id="pvSideFootprint" class="font-medium">0.00</span> cm<br/>
                PM efficiency: <span id="pmEfficiency" class="font-medium">90</span>%
              </div>
            </div>
            <div class="text-center">
              <div class="text-sm font-medium text-gray-700 mb-2">Real-Size Preview</div>
              <div id="pvPreview" class="relative inline-block mb-2">
                <div id="pvFrame"></div>
                <div id="pvSquare" class="pv-square"></div>
                <!-- inside active labels -->
                <div id="pvLabelTop">0.00 cm</div>
                <div id="pvLabelLeft">0.00 cm</div>
                <!-- footprint labels right & bottom -->
                <div id="pvFrameLabelRight" class="frameLabel">0.00 cm footprint</div>
                <div id="pvFrameLabelBottom" class="frameLabel">0.00 cm footprint</div>
              </div>
              <p class="text-[11px] text-gray-500">Actual size based on screen DPI</p>
            </div>
          </div>

          <!-- LEH Energy (spans cols 1-2) -->
          <div class="gauge p-4 rounded-2xl card md:col-span-2">
            <div class="flex items-center mb-2">
              <div class="w-2 h-6 rounded-full mr-3" style="background:linear-gradient(to bottom,#06b6d4,#10b981)"></div>
              <h4 class="text-xl font-bold text-gray-800">LEH Energy Generated (EOL)</h4>
            </div>
            <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-3 mb-2">
              <div class="bg-white/70 rounded-xl p-3 border border-emerald-100">
                <div class="text-xs text-emerald-700 font-semibold mb-1">PV-only</div>
                <div class="text-sm text-gray-500 mb-1">Instant Power</div>
                <div class="text-2xl font-bold text-emerald-700"><span id="lehPower_mW">0.000</span> <span class="text-base font-semibold">mW</span></div>
              </div>
              <div class="bg-white/70 rounded-xl p-3 border border-emerald-100">
                <div class="text-xs text-emerald-700 font-semibold mb-1">PV-only</div>
                <div class="text-sm text-gray-500 mb-1">Energy per Day</div>
                <div class="text-2xl font-bold text-emerald-700"><span id="lehEnergyDay_mWh">0.000</span> <span class="text-base font-semibold">mWh</span></div>
              </div>
              <div class="bg-white/70 rounded-xl p-3 border border-emerald-100">
                <div class="text-xs text-emerald-700 font-semibold mb-1">PV-only</div>
                <div class="text-sm text-gray-500 mb-1">Energy per Month</div>
                <div class="text-2xl font-bold text-emerald-700"><span id="lehEnergyMonth_mWh">0.000</span> <span class="text-base font-semibold">mWh</span></div>
              </div>
              <div class="bg-white/70 rounded-xl p-3 border border-emerald-100">
                <div class="text-xs text-emerald-700 font-semibold mb-1">PV-only</div>
                <div class="text-sm text-gray-500 mb-1">Energy over Lifetime</div>
                <div class="text-2xl font-bold text-emerald-700"><span id="lehEnergyLife_Wh">0.000</span> <span class="text-base font-semibold">Wh</span></div>
              </div>
            </div>
            <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-3">
              <div class="bg-white/70 rounded-xl p-3 border border-emerald-100">
                <div class="text-xs text-emerald-700 font-semibold mb-1">After PM (×<span id="lehPmEffLabel1">90</span>%)</div>
                <div class="text-sm text-gray-500 mb-1">Instant Power</div>
                <div class="text-2xl font-bold text-emerald-700"><span id="lehPower_mW_pm">0.000</span> <span class="text-base font-semibold">mW</span></div>
              </div>
              <div class="bg-white/70 rounded-xl p-3 border border-emerald-100">
                <div class="text-xs text-emerald-700 font-semibold mb-1">After PM (×<span id="lehPmEffLabel2">90</span>%)</div>
                <div class="text-sm text-gray-500 mb-1">Energy per Day</div>
                <div class="text-2xl font-bold text-emerald-700"><span id="lehEnergyDay_mWh_pm">0.000</span> <span class="text-base font-semibold">mWh</span></div>
              </div>
              <div class="bg-white/70 rounded-xl p-3 border border-emerald-100">
                <div class="text-xs text-emerald-700 font-semibold mb-1">After PM (×<span id="lehPmEffLabel3">90</span>%)</div>
                <div class="text-sm text-gray-500 mb-1">Energy per Month</div>
                <div class="text-2xl font-bold text-emerald-700"><span id="lehEnergyMonth_mWh_pm">0.000</span> <span class="text-base font-semibold">mWh</span></div>
              </div>
              <div class="bg-white/70 rounded-xl p-3 border border-emerald-100">
                <div class="text-xs text-emerald-700 font-semibold mb-1">After PM (×<span id="lehPmEffLabel4">90</span>%)</div>
                <div class="text-sm text-gray-500 mb-1">Energy over Lifetime</div>
                <div class="text-2xl font-bold text-emerald-700"><span id="lehEnergyLife_Wh_pm">0.000</span> <span class="text-base font-semibold">Wh</span></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Constants Modal -->
  <div id="constantsModal" class="modal items-center justify-center p-4">
    <div class="bg-white w-full max-w-4xl max-h-[85vh] overflow-y-auto rounded-xl p-6">
      <div class="flex justify-between items-center mb-4 pb-3 border-b">
        <h3 class="text-xl font-bold text-gray-800">Constants</h3>
        <button id="constantsClose" class="text-3xl font-bold text-gray-400 hover:text-gray-600 leading-none">&times;</button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <div class="flex flex-col gap-2"><label class="text-sm font-medium text-gray-700">Darkness Period (months)</label><input id="darknessPeriod" type="number" value="3" step="0.1" class="px-3 py-2 border-2 border-gray-300 rounded-lg text-sm focus:outline-none focus:border-indigo-500"></div>
        <div class="flex flex-col gap-2"><label class="text-sm font-medium text-gray-700">Seconds in Hour</label><input id="secondsInHour" type="number" value="3600" step="1" class="px-3 py-2 border-2 border-gray-300 rounded-lg text-sm focus:outline-none focus:border-indigo-500"></div>
        <div class="flex flex-col gap-2"><label class="text-sm font-medium text-gray-700">Seconds in Day</label><input id="secondsInDay" type="number" value="86400" step="1" class="px-3 py-2 border-2 border-gray-300 rounded-lg text-sm focus:outline-none focus:border-indigo-500"></div>
        <div class="flex flex-col gap-2"><label class="text-sm font-medium text-gray-700">Days in Month</label><input id="daysInMonth" type="number" value="31" step="1" class="px-3 py-2 border-2 border-gray-300 rounded-lg text-sm focus:outline-none focus:border-indigo-500"></div>
        <div class="flex flex-col gap-2"><label class="text-sm font-medium text-gray-700">Power Generation per Lux (mW/cm²/lux)</label><input id="powerGenerationPerLux" type="number" value="0.00003" step="0.00001" class="px-3 py-2 border-2 border-gray-300 rounded-lg text-sm focus:outline-none focus:border-indigo-500"></div>
        <div class="flex flex-col gap-2"><label class="text-sm font-medium text-gray-700">Cell Degradation per Month (%)</label><input id="cellDegradationPerMonth" type="number" value="0.185780" step="0.000001" class="px-3 py-2 border-2 border-gray-300 rounded-lg text-sm focus:outline-none focus:border-indigo-500"></div>
      </div>
    </div>
  </div>

  <!-- Calculated Values Modal -->
  <div id="calculatedModal" class="modal items-center justify-center p-4">
    <div class="bg-white w-full max-w-4xl max-h-[85vh] overflow-y-auto rounded-xl p-6">
      <div class="flex justify-between items-center mb-4 pb-3 border-b">
        <h3 class="text-xl font-bold text-gray-800">Calculated Values</h3>
        <button id="calculatedClose" class="text-3xl font-bold text-gray-400 hover:text-gray-600 leading-none">&times;</button>
      </div>
      <div id="calculatedGrid" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
    </div>
  </div>

<script>
window.addEventListener('DOMContentLoaded', () => {
  const byId = (id)=>document.getElementById(id);
  const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));

  // Constants (editable in modal)
  let constants = {
    darknessPeriod:3,
    secondsInHour:3600,
    secondsInDay:86400,
    daysInMonth:31,
    powerGenerationPerLux:0.00003,
    cellDegradationPerMonth:0.185780
  };

  const storageDischarge = {
    CR:{ annual:1.5 }, LiPo:{ monthly:2.5 }, LiFePO:{ monthly:1.5 },
    LTO:{ monthly:3.0 }, NiMH:{ monthly:1.5 }, Supercap:{ monthly:20.0 }, Hybridcap:{ monthly:20.0 }
  };
  const pmEfficiencies = { PMIC:90, Discrete:75, Direct:50 };

  // Slider filled track
  function colorFill(sliderId, color){
    const el = byId(sliderId); if(!el) return;
    const paint=()=>{
      const min=+el.min||0, max=+el.max||100, val=+el.value||0;
      const p=((val-min)/(max-min))*100;
      el.style.background=`linear-gradient(90deg, ${color} 0%, ${color} ${p}%, var(--track) ${p}%, var(--track) 100%)`;
    };
    el.addEventListener('input', paint); paint();
  }
  function link(sliderId, numId, color){
    const s=byId(sliderId), n=byId(numId); if(!s||!n) return;
    const fromS=()=>{ n.value=s.value; colorFill(sliderId,color); calculate(); };
    const fromN=()=>{ const v=parseFloat(n.value);
      const min=parseFloat(n.min), max=parseFloat(n.max);
      if(!isNaN(v) && v>=min && v<=max) s.value=v;
      colorFill(sliderId,color); calculate();
    };
    s.addEventListener('input', fromS);
    n.addEventListener('input', fromN);
    colorFill(sliderId,color);
  }

  // Wire sliders
  link('systemVoltage','systemVoltageNum','var(--sys)');
  link('intervalBetweenPulses','intervalBetweenPulsesNum','var(--sys)');
  link('sleepCurrent','sleepCurrentNum','var(--sys)');
  link('pulseDuration','pulseDurationNum','var(--sys)');
  link('pulseCurrent','pulseCurrentNum','var(--sys)');
  link('lightIntensity','lightIntensityNum','var(--env)');
  link('lightDuration','lightDurationNum','var(--env)');
  link('deviceLifetime','deviceLifetimeNum','var(--env)');

  // Radios
  document.body.addEventListener('click',(e)=>{
    const opt=e.target.closest('.radio-option'); if(!opt) return;
    const input=opt.querySelector('input[type="radio"]'); if(!input) return;
    const name=input.name;
    document.querySelectorAll(`input[name="${name}"]`).forEach(inp=>{
      const o=inp.closest('.radio-option'); if(!o) return;
      o.classList.remove('selected'); o.style.background='white'; o.style.borderColor='#d1d5db'; o.style.color='#111827';
    });
    opt.classList.add('selected');
    opt.style.background='linear-gradient(135deg,var(--env),var(--env-dark))';
    opt.style.borderColor='var(--env)'; opt.style.color='#fff';
    input.checked=true;
    calculate();
  });

  // Gauges with overflow rings
  function updateGauge({gaugeId, overflowId, value, maxValue}){
    const main = byId(gaugeId), over = byId(overflowId);
    if(!main) return;
    const rMain=70, cMain=2*Math.PI*rMain;
    const frac=value/maxValue;
    const clamped=Math.max(0,Math.min(1,frac));
    main.style.strokeDashoffset = (cMain - clamped*cMain);
    if(over){
      const rOver=58, cOver=2*Math.PI*rOver;
      const overflow=Math.max(0,frac-1);
      over.classList.toggle('opacity-0', overflow<=0);
      const overClamped=Math.min(1,overflow);
      over.style.strokeDasharray=cOver;
      over.style.strokeDashoffset=(cOver - overClamped*cOver);
    }
  }

  // DPI & PV preview
  function dpi(){ const el=document.createElement('div'); el.style.width='1in'; el.style.height='1in'; el.style.position='absolute'; el.style.left='-100%'; el.style.top='-100%'; document.body.appendChild(el); const d=el.offsetWidth; el.remove(); return d||96; }
  const pxPerCm = dpi()/2.54;

  function updatePVPreview(sideCm){
    const pvPreview=byId('pvPreview'), pvSquare=byId('pvSquare'), pvFrame=byId('pvFrame');
    const labelTop=byId('pvLabelTop'), labelLeft=byId('pvLabelLeft');
    const rightLab=byId('pvFrameLabelRight'), bottomLab=byId('pvFrameLabelBottom');
    if(!pvPreview||!pvSquare||!pvFrame) return;

    if(!isFinite(sideCm)){
      pvPreview.style.width='180px'; pvPreview.style.height='196px';
      pvFrame.style.width='140px'; pvFrame.style.height='140px'; pvFrame.style.left='0'; pvFrame.style.top='0';
      pvSquare.style.width='100px'; pvSquare.style.height='100px'; pvSquare.style.left='20px'; pvSquare.style.top='20px';
      labelTop.textContent='∞ cm'; labelLeft.textContent='∞ cm';
      rightLab.textContent='∞ cm footprint'; rightLab.style.left='146px'; rightLab.style.top='70px';
      bottomLab.textContent='∞ cm footprint'; bottomLab.style.left='70px'; bottomLab.style.top='146px'; bottomLab.style.transform='translate(-50%,0)';
      return;
    }
    const off=0.65; // 6.5 mm
    const footSide=sideCm + 2*off;
    const sizePx=sideCm*pxPerCm, framePx=footSide*pxPerCm;
    const maxFrame=280, scale=framePx>maxFrame ? maxFrame/framePx : 1;

    pvPreview.style.width=`${framePx*scale + 24}px`;
    pvPreview.style.height=`${framePx*scale + 24}px`;

    pvFrame.style.width=`${framePx*scale}px`;
    pvFrame.style.height=`${framePx*scale}px`;
    pvFrame.style.left='0px'; pvFrame.style.top='0px';

    const offPx=off*pxPerCm*scale;
    pvSquare.style.width=`${sizePx*scale}px`;
    pvSquare.style.height=`${sizePx*scale}px`;
    pvSquare.style.left=`${offPx}px`; pvSquare.style.top=`${offPx}px`;

    // inside labels (active square)
    labelTop.style.left = `${offPx + (sizePx*scale)/2}px`;
    labelTop.style.top = `${offPx + 6}px`;
    labelTop.style.transform='translate(-50%,0)';
    labelTop.textContent = `${sideCm.toFixed(2)} cm${scale<1?' (scaled)':''}`;

    labelLeft.style.left = `${offPx + 6}px`;
    labelLeft.style.top = `${offPx + (sizePx*scale)/2}px`;
    labelLeft.style.transform='translate(0,-50%)';
    labelLeft.textContent = `${sideCm.toFixed(2)} cm${scale<1?' (scaled)':''}`;

    // footprint labels: right & bottom
    rightLab.textContent = `${footSide.toFixed(2)} cm footprint`;
    rightLab.style.left = `${framePx*scale + 6}px`;
    rightLab.style.top = `${(framePx*scale)/2}px`;
    rightLab.style.transform='translate(0,-50%)';

    bottomLab.textContent = `${footSide.toFixed(2)} cm footprint`;
    bottomLab.style.left = `${(framePx*scale)/2}px`;
    bottomLab.style.top = `${framePx*scale + 6}px`;
    bottomLab.style.transform='translate(-50%,0)';
  }

  // Calculation
  function calculate(){
    try{
      const V  = clamp(+byId('systemVoltageNum').value||3.0, 1.4, 3.3);
      const T  = clamp(+byId('intervalBetweenPulsesNum').value||600, 1, 3600);
      const In = clamp(+byId('sleepCurrentNum').value||650, 0, 1000);
      const tp = clamp(+byId('pulseDurationNum').value||5, 0.5, 50)/1000;
      const Ip = clamp(+byId('pulseCurrentNum').value||11, 0.1, 30);
      const Lx = clamp(+byId('lightIntensityNum').value||200, 1, 2000);
      const Lm = clamp(+byId('lightDurationNum').value||60, 1, 1440);
      const devLifeMonths = clamp(+byId('deviceLifetimeNum').value||36, 1, 120);

      const stEl = document.querySelector('input[name="storageType"]:checked');
      const pmEl = document.querySelector('input[name="pmSolution"]:checked');
      const storageType = stEl ? stEl.value : 'LiPo';
      const pmSolution  = pmEl ? pmEl.value : 'PMIC';

      const PulsesPerDay = constants.secondsInDay / T;
      const PowerPerPulse_mW = V * Ip;
      const PowerDuringSleep_mW = V * (In/1e6);
      const EnergyPerPulse_mWh = (PowerPerPulse_mW * tp) / constants.secondsInHour;
      const EnergyPerSleepInterval_mWh = PowerDuringSleep_mW * Math.max(T - tp, 0) / constants.secondsInHour;
      const PulseEnergyPerDay_mWh = EnergyPerPulse_mWh * PulsesPerDay;
      const SleepEnergyPerDay_mWh = EnergyPerSleepInterval_mWh * PulsesPerDay;
      const EnergyPerDay_mWh = PulseEnergyPerDay_mWh + SleepEnergyPerDay_mWh;

      const EnergyDarkness_mWh = EnergyPerDay_mWh * constants.daysInMonth * constants.darknessPeriod;
      const MinStorage_mWh = EnergyDarkness_mWh + EnergyPerDay_mWh;

      // Self-discharge
      let MonthlySelfDischargePct;
      if (storageType==='CR'){
        MonthlySelfDischargePct = 100*(1 - Math.pow(1 - storageDischarge.CR.annual/100, 1/12));
      } else {
        MonthlySelfDischargePct = storageDischarge[storageType].monthly;
      }
      const r = MonthlySelfDischargePct/100;
      const remain = Math.pow(1 - r, constants.darknessPeriod);
      const EnergyLoss_mWh = MinStorage_mWh * (1 - remain);
      const TotalStorage_mWh = MinStorage_mWh + EnergyLoss_mWh;

      // LEH generation (EOL)
      const LEH_pristine_mWcm2 = Lx * constants.powerGenerationPerLux;
      const LEH_degradation_mWcm2 = LEH_pristine_mWcm2 * (constants.cellDegradationPerMonth/100) * devLifeMonths;
      const LEH_EOL_mWcm2 = Math.max(0, LEH_pristine_mWcm2 - LEH_degradation_mWcm2);
      const Harvest_EOL_mWh_cm2_day = LEH_EOL_mWcm2 * (Lm/60);

      const eff = Math.max(0, Math.min(1, (pmEfficiencies[pmSolution]||90)/100));
      const denom = Harvest_EOL_mWh_cm2_day * eff;
      const Area_cm2 = denom>0 ? (EnergyPerDay_mWh/denom) : Infinity;
      const Side_cm  = isFinite(Area_cm2) ? Math.sqrt(Area_cm2) : Infinity;

      const LEH_Power_mW = isFinite(Area_cm2) ? (LEH_EOL_mWcm2 * Area_cm2) : Infinity;
      const LEH_Eday_mWh = isFinite(Area_cm2) ? (Harvest_EOL_mWh_cm2_day * Area_cm2) : Infinity;
      const LEH_Emonth_mWh = isFinite(LEH_Eday_mWh) ? (LEH_Eday_mWh * constants.daysInMonth) : Infinity;
      const LEH_Elife_Wh = isFinite(LEH_Emonth_mWh) ? ((LEH_Emonth_mWh * devLifeMonths)/1000) : Infinity;

      const LEH_Power_mW_pm = isFinite(LEH_Power_mW) ? LEH_Power_mW*eff : Infinity;
      const LEH_Eday_mWh_pm = isFinite(LEH_Eday_mWh) ? LEH_Eday_mWh*eff : Infinity;
      const LEH_Emonth_mWh_pm = isFinite(LEH_Emonth_mWh) ? LEH_Emonth_mWh*eff : Infinity;
      const LEH_Elife_Wh_pm = isFinite(LEH_Elife_Wh) ? LEH_Elife_Wh*eff : Infinity;

      // Update UI
      byId('dailyEnergy').textContent = EnergyPerDay_mWh.toFixed(3);
      byId('pulseEnergy').textContent = PulseEnergyPerDay_mWh.toFixed(3);
      byId('sleepEnergy').textContent = SleepEnergyPerDay_mWh.toFixed(3);

      byId('totalStorage').textContent = TotalStorage_mWh.toFixed(3);
      byId('darkPeriodEnergy').textContent = EnergyDarkness_mWh.toFixed(3);
      byId('minStorage').textContent = MinStorage_mWh.toFixed(3);
      byId('selfDischarge').textContent = MonthlySelfDischargePct.toFixed(1);

      byId('pvArea').textContent = isFinite(Area_cm2)? Area_cm2.toFixed(2):'∞';
      byId('pvSideActive').textContent = isFinite(Side_cm)? Side_cm.toFixed(2):'∞';
      const footSide = isFinite(Side_cm)? (Side_cm + 2*0.65): Infinity;
      byId('pvSideFootprint').textContent = isFinite(footSide)? footSide.toFixed(2):'∞';
      byId('pmEfficiency').textContent = Math.round(eff*100);

      byId('lehPower_mW').textContent = isFinite(LEH_Power_mW)? LEH_Power_mW.toFixed(3):'∞';
      byId('lehEnergyDay_mWh').textContent = isFinite(LEH_Eday_mWh)? LEH_Eday_mWh.toFixed(3):'∞';
      byId('lehEnergyMonth_mWh').textContent = isFinite(LEH_Emonth_mWh)? LEH_Emonth_mWh.toFixed(3):'∞';
      byId('lehEnergyLife_Wh').textContent = isFinite(LEH_Elife_Wh)? LEH_Elife_Wh.toFixed(3):'∞';

      ['lehPmEffLabel1','lehPmEffLabel2','lehPmEffLabel3','lehPmEffLabel4']
        .forEach(id=>{ const el=byId(id); if(el) el.textContent = Math.round(eff*100); });

      byId('lehPower_mW_pm').textContent = isFinite(LEH_Power_mW_pm)? LEH_Power_mW_pm.toFixed(3):'∞';
      byId('lehEnergyDay_mWh_pm').textContent = isFinite(LEH_Eday_mWh_pm)? LEH_Eday_mWh_pm.toFixed(3):'∞';
      byId('lehEnergyMonth_mWh_pm').textContent = isFinite(LEH_Emonth_mWh_pm)? LEH_Emonth_mWh_pm.toFixed(3):'∞';
      byId('lehEnergyLife_Wh_pm').textContent = isFinite(LEH_Elife_Wh_pm)? LEH_Elife_Wh_pm.toFixed(3):'∞';

      // Gauges: max 6 and 40; overflow ring shows extra
      updateGauge({gaugeId:'dailyEnergyGauge', overflowId:'dailyOverflow', value:EnergyPerDay_mWh, maxValue:6});
      updateGauge({gaugeId:'storageGauge', overflowId:'storageOverflow', value:TotalStorage_mWh, maxValue:40});

      updatePVPreview(Side_cm);

      // stash for modal
      window.calculatedValues = {
        PulsesPerDay, PowerPerPulse_mW, PowerDuringSleep_mW,
        EnergyPerPulse_mWh, EnergyPerSleepInterval_mWh,
        PulseEnergyPerDay_mWh, SleepEnergyPerDay_mWh, EnergyPerDay_mWh,
        EnergyDarkness_mWh, MinStorage_mWh, MonthlySelfDischargePct, EnergyLoss_mWh, TotalStorage_mWh,
        LEH_pristine_mWcm2, LEH_degradation_mWcm2, LEH_EOL_mWcm2, Harvest_EOL_mWh_cm2_day,
        Area_cm2, Side_cm, PMEfficiency: Math.round(eff*100)
      };
    }catch(e){ console.error(e); }
  }

  function updateCalculatedModal(){
    const g=byId('calculatedGrid'); const v=window.calculatedValues||{};
    const items = [
      ['Pulses Per Day', v.PulsesPerDay,'pulses'],
      ['Power Per Pulse', v.PowerPerPulse_mW,'mW'],
      ['Power During Sleep', v.PowerDuringSleep_mW,'mW'],
      ['Energy Per Pulse', v.EnergyPerPulse_mWh,'mWh'],
      ['Energy Per Sleep Interval', v.EnergyPerSleepInterval_mWh,'mWh'],
      ['Pulse Energy Per Day', v.PulseEnergyPerDay_mWh,'mWh'],
      ['Sleep Energy Per Day', v.SleepEnergyPerDay_mWh,'mWh'],
      ['Total Energy Per Day', v.EnergyPerDay_mWh,'mWh'],
      ['Energy During Darkness', v.EnergyDarkness_mWh,'mWh'],
      ['Minimum Storage', v.MinStorage_mWh,'mWh'],
      ['Monthly Self-Discharge', v.MonthlySelfDischargePct,'%'],
      ['Energy Loss (Self-discharge)', v.EnergyLoss_mWh,'mWh'],
      ['Total Storage Required', v.TotalStorage_mWh,'mWh'],
      ['LEH Pristine Power', v.LEH_pristine_mWcm2,'mW/cm²'],
      ['LEH Degradation', v.LEH_degradation_mWcm2,'mW/cm²'],
      ['LEH EOL Power', v.LEH_EOL_mWcm2,'mW/cm²'],
      ['Harvest EOL / Day', v.Harvest_EOL_mWh_cm2_day,'mWh/cm²/day'],
      ['Required Area', v.Area_cm2,'cm²'],
      ['Square Side (active)', v.Side_cm,'cm'],
      ['PM Efficiency', v.PMEfficiency,'%']
    ];
    g.innerHTML = items.map(([label,val,unit])=>`
      <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-200">
        <span class="font-medium text-gray-700">${label}</span>
        <span class="font-semibold text-gray-800">${(typeof val==='number' && isFinite(val))? val.toFixed(6): (val===Infinity?'∞':'—')} ${unit}</span>
      </div>`).join('');
  }

  // Buttons / Modals
  const constantsModal = byId('constantsModal');
  const calculatedModal = byId('calculatedModal');

  byId('constantsBtn').addEventListener('click', ()=>{
    // populate fields
    Object.keys(constants).forEach(k=>{ const el=byId(k); if(el) el.value = constants[k]; });
    constantsModal.classList.add('show');
  });
  byId('calculatedBtn').addEventListener('click', ()=>{
    updateCalculatedModal();
    calculatedModal.classList.add('show');
  });
  byId('constantsClose').addEventListener('click', ()=>{
    // save & close
    Object.keys(constants).forEach(k=>{ const el=byId(k); if(el){ const num=parseFloat(el.value); if(!isNaN(num)) constants[k]=num; } });
    constantsModal.classList.remove('show');
    calculate();
  });
  byId('calculatedClose').addEventListener('click', ()=>calculatedModal.classList.remove('show'));

  window.addEventListener('click',(e)=>{
    if(e.target===constantsModal) byId('constantsClose').click();
    if(e.target===calculatedModal) calculatedModal.classList.remove('show');
  });

  // Reset
  byId('resetBtn').addEventListener('click', ()=>{
    const set=(id,v)=>{ const el=byId(id); if(el){ el.value=v; el.dispatchEvent(new Event('input')); } };
    set('systemVoltage',3.0); set('systemVoltageNum',3.0);
    set('intervalBetweenPulses',600); set('intervalBetweenPulsesNum',600);
    set('sleepCurrent',650); set('sleepCurrentNum',650);
    set('pulseDuration',5); set('pulseDurationNum',5);
    set('pulseCurrent',11); set('pulseCurrentNum',11);
    set('lightIntensity',200); set('lightIntensityNum',200);
    set('lightDuration',60); set('lightDurationNum',60);
    set('deviceLifetime',36); set('deviceLifetimeNum',36);

    // radios default
    const stor=document.querySelector('input[name="storageType"][value="LiPo"]'); if(stor) stor.checked=true;
    const pm=document.querySelector('input[name="pmSolution"][value="PMIC"]'); if(pm) pm.checked=true;
    document.querySelectorAll('.radio-option').forEach(o=>{
      o.classList.remove('selected'); o.style.background='white'; o.style.borderColor='#d1d5db'; o.style.color='#111827';
    });
    document.querySelectorAll('input[name="storageType"]').forEach(inp=>{
      if(inp.checked){ const o=inp.closest('.radio-option'); if(o){ o.classList.add('selected'); o.style.background='linear-gradient(135deg,var(--env),var(--env-dark))'; o.style.borderColor='var(--env)'; o.style.color='#fff'; } }
    });
    document.querySelectorAll('input[name="pmSolution"]').forEach(inp=>{
      if(inp.checked){ const o=inp.closest('.radio-option'); if(o){ o.classList.add('selected'); o.style.background='linear-gradient(135deg,var(--env),var(--env-dark))'; o.style.borderColor='var(--env)'; o.style.color='#fff'; } }
    });
    calculate();
  });

  // Initialize once
  ['systemVoltage','intervalBetweenPulses','sleepCurrent','pulseDuration','pulseCurrent','lightIntensity','lightDuration','deviceLifetime']
    .forEach(id=>{ const el=byId(id); if(el) el.dispatchEvent(new Event('input')); });
  calculate();
});
</script>
</body>
</html>
